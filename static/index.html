<html>
<head>
<link rel="stylesheet" href="css/monkey.css" type="text/css" media="screen" /> 

<script src="js/jquery-1.4.2.min.js"></script>
<script src="js/jquery.url-bb2bf.js"></script>
<script src="js/underscore-0.6.0.min.js"></script>
<script src="js/logger.js"></script>
<script src="js/spriteful.js"></script>

<script>
  $(function() {
    logger.configure({verbosity: "debug"});
    
    var ws = new WebSocket("ws://localhost:8888/connect");
    
    var loop = function(evt) {
      var changes = JSON.parse(evt.data).changes;
      _.each(changes, function(message) {
        if (message.type == 'move') {
          var $target = $("#" + message.id);
          var dest = $(_.template("#cell-<%= x %>-<%= y %>", {
            x: message.position[0], 
            y: message.position[1]
          }));
          $target.intentions([function() { $target.data('move_func')($target, dest) }]);
        } else if (message.type == 'new') {
          var dest = _.template("#cell-<%= x %>-<%= y %>", {
            x: message.position[0], 
            y: message.position[1]
          });
          $(dest).placeSprite(message);
        }
      })
    };
    
    var init = function(evt) {
      var config = JSON.parse(evt.data)
      logger.info("Initializing Spriteful: ");
      logger.info(config);
      
      $("#content").spriteful(config);
      $('.' + config.tile_class).addClass('grass');
      
      _.each(config.entities, function(entity) {
        var dest = _.template("#cell-<%= x %>-<%= y %>", {
          x: entity.position[0], 
          y: entity.position[1]
        });
        $(dest).placeSprite(entity);
      });

      ws.onmessage = loop;
    };
    
    ws.onmessage = init;


  })
</script>
</head>
<body>
  <ul>
    <li>Click on the board to move</li>
    <li>Press space to bite</li>
  </ul>
  <div id="content"></div>
</body>
</html>